<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nubert Supremacy</title>
  <style>
    @font-face {
      font-family: 'Determination';
      src: url('Determination.ttf') format('truetype');
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #050509;
      color: #f0f0f0;
      font-family: 'Determination', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      text-align: center;
    }

    h1 {
      margin-bottom: 1rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    #card {
      padding: 2rem 3rem;
      border-radius: 12px;
      background: rgba(10, 10, 20, 0.9);
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
    }

    img {
      max-width: 240px;
      height: auto;
      display: block;
      margin: 0 auto 1rem;
      image-rendering: pixelated;
    }

    button {
      margin-top: 0.5rem;
      padding: 0.6rem 1.8rem;
      border-radius: 999px;
      border: 1px solid #f0f0f0;
      background: transparent;
      color: inherit;
      font: inherit;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    button[disabled] {
      opacity: 0.4;
      cursor: default;
    }

    button + button {
      margin-left: 0.5rem;
    }

    #streak {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.7);
      font-size: 0.8rem;
    }

    #message {
      margin-top: 1rem;
      min-height: 1.5em;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div id="streak">Streak: 0</div>

  <div id="card">
    <h1>Nubert Supremacy</h1>
    <img src="nubert.png" alt="Nubert" id="nubert-image">

    <div>
      <button id="pray-btn">pray</button>
      <button id="mercy-btn" style="display:none;">Beg For Mercy</button>
    </div>

    <div id="message"></div>
  </div>

  <script>
    (function () {
      const STORAGE_PREFIX = 'nubert_supremacy_';
      const KEY_LAST_PRAYER = STORAGE_PREFIX + 'last_prayer_date';
      const KEY_STREAK = STORAGE_PREFIX + 'streak';
      const KEY_EVER = STORAGE_PREFIX + 'has_ever_prayed';
      const KEY_NEEDS_MERCY = STORAGE_PREFIX + 'needs_mercy';
      const KEY_LAST_STREAK_BEFORE_FAIL = STORAGE_PREFIX + 'last_streak_before_fail';

      const prayBtn = document.getElementById('pray-btn');
      const mercyBtn = document.getElementById('mercy-btn');
      const streakEl = document.getElementById('streak');
      const messageEl = document.getElementById('message');

      function getTodayKey() {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        // Local date string (calendar day, not 24h timer)
        return `${y}-${m}-${day}`;
      }

      function daysBetween(dateKey1, dateKey2) {
        if (!dateKey1 || !dateKey2) return null;
        const [y1, m1, d1] = dateKey1.split('-').map(Number);
        const [y2, m2, d2] = dateKey2.split('-').map(Number);
        const a = new Date(y1, m1 - 1, d1);
        const b = new Date(y2, m2 - 1, d2);
        const diffMs = b - a;
        return Math.floor(diffMs / (1000 * 60 * 60 * 24));
      }

      function getNumber(key, fallback) {
        const raw = localStorage.getItem(key);
        const n = Number(raw);
        return Number.isFinite(n) ? n : fallback;
      }

      function loadState() {
        return {
          lastPrayerDate: localStorage.getItem(KEY_LAST_PRAYER),
          streak: getNumber(KEY_STREAK, 0),
          hasEverPrayed: localStorage.getItem(KEY_EVER) === 'true',
          needsMercy: localStorage.getItem(KEY_NEEDS_MERCY) === 'true',
          lastStreakBeforeFail: getNumber(KEY_LAST_STREAK_BEFORE_FAIL, 0)
        };
      }

      function saveState(state) {
        localStorage.setItem(KEY_LAST_PRAYER, state.lastPrayerDate || '');
        localStorage.setItem(KEY_STREAK, String(state.streak || 0));
        localStorage.setItem(KEY_EVER, state.hasEverPrayed ? 'true' : 'false');
        localStorage.setItem(KEY_NEEDS_MERCY, state.needsMercy ? 'true' : 'false');
        localStorage.setItem(KEY_LAST_STREAK_BEFORE_FAIL, String(state.lastStreakBeforeFail || 0));
      }

      function updateUI(state) {
        const todayKey = getTodayKey();
        const alreadyPrayedToday = state.lastPrayerDate === todayKey;

        streakEl.textContent = 'Streak: ' + (state.streak || 0);

        if (alreadyPrayedToday) {
          prayBtn.textContent = 'Said Prayers';
          prayBtn.disabled = true;
          if (!messageEl.textContent) {
            messageEl.textContent = "You already prayed today.";
          }
        } else {
          prayBtn.textContent = 'pray';
          prayBtn.disabled = false;

          if (state.streak > 0 && !state.needsMercy) {
            messageEl.textContent = "Do not disappoint Nubert today.";
          } else if (state.hasEverPrayed && state.needsMercy) {
            messageEl.textContent = "Your streak is broken. Beg for mercyâ€¦";
          } else if (!state.hasEverPrayed) {
            messageEl.textContent = "Begin your devotion.";
          } else if (!messageEl.textContent) {
            messageEl.textContent = "";
          }
        }

        // Show Beg For Mercy only when:
        // - streak is 0
        // - user has prayed before
        // - they actually missed a day (needsMercy)
        if (state.streak === 0 && state.hasEverPrayed && state.needsMercy) {
          mercyBtn.style.display = 'inline-block';
        } else {
          mercyBtn.style.display = 'none';
        }
      }

      function init() {
        let state = loadState();
        const todayKey = getTodayKey();

        // If they missed at least one full calendar day, break streak & require mercy
        if (state.hasEverPrayed && state.lastPrayerDate) {
          const gap = daysBetween(state.lastPrayerDate, todayKey);
          if (gap !== null && gap > 1 && state.streak > 0) {
            state.lastStreakBeforeFail = state.streak;
            state.streak = 0;
            state.needsMercy = true;
          }
        }

        saveState(state);
        updateUI(state);
      }

      prayBtn.addEventListener('click', function () {
        let state = loadState();
        const todayKey = getTodayKey();

        if (state.lastPrayerDate === todayKey) {
          messageEl.textContent = "Nubert heard you already.";
          updateUI(state);
          return;
        }

        // If they already missed a day, they MUST use Beg For Mercy
        if (state.hasEverPrayed && state.lastPrayerDate) {
          const gap = daysBetween(state.lastPrayerDate, todayKey);
          if (gap !== null && gap > 1) {
            state.lastStreakBeforeFail = state.streak;
            state.streak = 0;
            state.needsMercy = true;
            saveState(state);
            messageEl.textContent = "You missed a day. Your streak is broken. Beg For Mercy.";
            updateUI(state);
            return;
          }
        }

        const lastDate = state.lastPrayerDate;
        let newStreak = 1;

        if (lastDate) {
          const gap = daysBetween(lastDate, todayKey);
          if (gap === 0) {
            messageEl.textContent = "Nubert heard you already.";
            updateUI(state);
            return;
          } else if (gap === 1) {
            newStreak = (state.streak || 0) + 1;
          }
        }

        state.lastPrayerDate = todayKey;
        state.streak = newStreak;
        state.hasEverPrayed = true;
        state.needsMercy = false;

        saveState(state);
        messageEl.textContent = "Said Prayers";
        updateUI(state);
      });

      mercyBtn.addEventListener('click', function () {
        let state = loadState();

        if (!(state.streak === 0 && state.hasEverPrayed && state.needsMercy)) {
          messageEl.textContent = "Nubert is not listening to mercy right now.";
          return;
        }

        const accepted = Math.random() < 0.5;

        if (accepted) {
          const todayKey = getTodayKey();
          state.streak = state.lastStreakBeforeFail || 1;
          state.lastPrayerDate = todayKey;
          state.needsMercy = false;

          saveState(state);
          messageEl.textContent = "Accepted, at least I'm the best.";
        } else {
          messageEl.textContent = "You asked for mercy, Nubert showed none.";
        }

        updateUI(state);
      });

      init();
    })();
  </script>
</body>
</html>
